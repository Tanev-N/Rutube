# Rutube

Rutube — ведущий российский видеопортал, предлагающий к просмотру тв онлайн, кинофильмы, сериалы, мультфильмы и пользовательское видео. смотри. создавай. загружай.

## 1. Тема и целевая Аудитория

### Аналитика аудитории

* **Пользователей:** 71 млн в месяц и 10 млн в день.
* **Визиты на сайт:** 411 млн в месяц.
* **Демография:** 61% мужчин и 39% женщин.
* **Основной возраст:** от 25 до 34 лет.

  ![график возраста и пола пользователей](https://github.com/Tanev-N/Rutube/blob/main/img/age_gender.png?raw=true)
* **Устройства:** 49% с персонального компьютера, 51% с мобильного устройства.

  ![статистика по устройствам](https://github.com/Tanev-N/Rutube/blob/main/img/device_distribution.png?raw=true)
* **Страны:** Россия, Казакстан, Беларусь, Украина, Германия.

  ![статистика по странам](https://github.com/Tanev-N/Rutube/blob/main/img/geography.png?raw=true)

### Функционнальность MVP

1. Регистрация и авторизация.
2. Просмотр видео пользователями - возможность ставить лайки, дизлайки.
3. Каналы - пользователь может сделать несколько каналов, в каждом канале публиковать видео.
4. Загрузка собственных видео на каналы.
5. Подписки - возможность подписываться на каналы, чтобы следить за авторами.
6. Комментарии - к видео, возможность лайкать комментарии и делать комментарии на комментарии.
7. Плейлисты - объединение видео в подборку как для себя, так и для других.
8. Рейтинг и рекомендательная система - видео, которые показывают пользователям на главной странице и в предложенных к видео.
9. История просмотра.

### Список источников

1. [Официальный телеграм канал Rutube.](https://t.me/rutube/4689)
2. [Метрики](https://www.similarweb.com/website/rutube.ru/#overview)

## 2. Расчет нагрузки

Так как у Rutube мало открытой информации, кроме MAU, DAU - https://tass.ru/ekonomika/22555439, будем операться на исследования YouTube и считать коэффициент.
Статистика Ютуба:

* MAU - 2.5 billion and DAU - 122 million - https://www.demandsage.com/youtube-stats/
* "1 billion hours video per day" and  "500 hours of content uploaded every minute"  - https://blog.youtube/press/
* "You can create up to 100 channels with one single YouTube account" and "more than 114 million active YouTube channels" - https://www.wyzowl.com/youtube-stats/
* "3.9 billion videos on YouTube, of which 826 million are YouTube Shorts" / normal video = 3900 - 826 = 3074 million - https://www.wyzowl.com/youtube-stats/
* "Videos on YouTube have an average length of 11.7 minutes" - https://www.wyzowl.com/youtube-stats/
* "**Most estimates conclude that YouTube has at least one exabyte (1,000,000 terabytes) of storage space in its data centers.**" - https://www.qqtube.com/blog/how-much-storage-does-youtube-have
* The average number of likes on YouTube is 16.48, and the median is 0. - https://www.intotheminds.com/blog/en/research-youtube-stats/#:~:text=Likes%2C%20comments%2C%20and%20subscribers,have%20no%20comments%20at%20all.
* As for comments, a YouTube video garners an average of 5.32. This figure conceals wide disparities. 72.64% of YouTube videos have no comments at all. This disparity is also reflected in the number of subscribers. While the average number of subscribers in the sample researched was 55,100 - https://www.intotheminds.com/blog/en/research-youtube-stats/
* The average number of views is 5868 - https://www.intotheminds.com/blog/en/research-youtube-stats/

Для перевода из ютуб метрик в рутуб метрики будет использовать 2 коэффициента: дневной (YouTube DAU / Rutube DAU ) и месячный по аналогии.
Назовём их RDAU = 122/14.3 = 8.5  и RMAU = 2500/70.5 = 35.5 и использовать будем для метрик, которые зависят от колличества пользователей.

Теперь имея характеристики ютуба оценим средний вес видео и сколько примерно весит посмотреть 1 минуту видео:

* Вес 1 видео = вес всех видео / колличетсво видео = 1 Эбайт / 3.9 b=illion = 282 МБайт.
* Вес 1 минуты = вес видео / среднюю длину видео = 282Мбайт / 11.7 = 24 Мбайт

Заметим, что каналов с видео всего 114 million, а MAU - 2.5 billion => 2500/114 = 22 - каждый RC=22 канал активно выпускает видео ( есть хотябы 1 )  => получается
на 1 канале Колличество видео / колличество каналов  = 34 видео на 1 канале или под 1 пользователя в среднем нужно выделать 34/22 = 1.545 видео

### Продуктовые метрики

| Метрика                                                                         | Значение   | Комментарий                                                                                                                                                                                                                                                                                                                                                                                                         |
| -------------------------------------------------------------------------------------- | ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Месячная аудитория                                                    | 70.5 млн        | По данным-[Mediascope](https://tass.ru/ekonomika/22555439).                                                                                                                                                                                                                                                                                                                                                               |
| Дневная аудитория (DAU)                                                | 14.3 млн        | По данным-[Mediascope](https://tass.ru/ekonomika/22555439).                                                                                                                                                                                                                                                                                                                                                               |
| **Средний размер хранилища на пользователя** |                    |                                                                                                                                                                                                                                                                                                                                                                                                                                |
| Видео                                                                             | 438.8 Мбайт   | 1.545 видео * вес 1 видео + Метаинфа для видео (Примим за 2 Мбайт)<br />( 1.545 средних ролика в среднем на канале , дальше будем изходить, что каждый польхователь хранит все эти ролики<br />и к нему всю прилегающую информацию для удобства ) |
| Канал                                                                             | 0.181 Мбайт   | ( Обложка (3 Мбайт) + ава канала(1 Мбайт)  + Описания канала и метаинфа(1 Кбайт) + ава канала(1 Мбайт) ) / RC. В колличестве 0.0454                                                                                                                                                                                                           |
| Профиль                                                                         | 1.0015 МБ       | Аватар (1 Мб) + метаданные (1.5 КБ)                                                                                                                                                                                                                                                                                                                                                                        |
| Плейлисты                                                                     | 400 байт       | Не смог найти в интернете информацию по плейлистам, могу предположить их больше чем видео на канале, но меньше,<br />чем комментариев, т.е около 2 x вес (ссылок на видео допустим в среднем 5 x 20 байт  + Описание (100 байт ))                          |
| Комментарии                                                                 | 8.2 Кбайт     | 5.32 комментариев под видео × 1.545 x вес комментария (примим за 1Кб)                                                                                                                                                                                                                                                                                                            |
| Подписки                                                                       | 1.15 Кбайт    | 55100 подписок × 16 Байт / RC / RMAU = 70.55 Подписок на человека                                                                                                                                                                                                                                                                                                                             |
| История Просмотров                                                    | 7.9 Кбайт     | 5868 просмотров x 1.545 × 20 Байт / RC.  266.72 просмотра на человека                                                                                                                                                                                                                                                                                                                   |
| Лайки под видео                                                           | 407 байт       | 16.48 лайков в среднем на видео x 1.545 видео x (16 байт)                                                                                                                                                                                                                                                                                                                                      |
| Лайки под комментами                                                 | 82 байта      | По своему ислледованию на просторах ютуба скажу, что сумма всех лайков под комментариями равна примерно 20% от лайков под видео<br />=> 3.3 лайка/5.32 = 0.62 лайка под комментами. В сумме 5.32 x 1.545 x 0.62 x 16 байт                                                           |
| Итого                                                                             | 440.013 Мбайт | С уверенностью можно сказать, что большая часть хранилища это видео, целых 99.5%.                                                                                                                                                                                                                                                                                |

### Технические метрики

Размер хранилища

| Тип данных                    | Количество | Объем         | Расчет                                                                                                                                                                |
| -------------------------------------- | -------------------- | ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Видео                             | 108.9 млн         | 28.8108 Пбайт | Колличество и объем берутся из прошлой таблицы и умножается на MAU<br />у всех следующих записей |
| Профили                         | 70.5 млн          | 67.3 Тбайт    |                                                                                                                                                                             |
| Канал                             | 3.2 млн           | 12 Тбайт      |                                                                                                                                                                             |
| Плейлисты                     | 141 млн           | 26 Гбайт     |                                                                                                                                                                             |
| Комментарии                 | 579.348 млн       | 0.53 Тбайт    |                                                                                                                                                                             |
| Подписки                       | 4.97 млрд        | 0.075 Тбайт   |                                                                                                                                                                             |
| История просмотров    | 29.04 млрд      | 0.51 Тбайт    |                                                                                                                                                                             |
| Лайки под видео           | 1.7946 млрд      | 26 Тбайт      |                                                                                                                                                                             |
| Лайки под комментами | 358.93 млн        | 5.34 Тбайт    |                                                                                                                                                                             |
| Итого                             |                      | 28.9479 Пбайт |                                                                                                                                                                             |

### Сетевой трафик

* "1 billion hours video per day" and  "500 hours of content uploaded every minute"  - https://blog.youtube/press/
* "Today, the average user spends about 30 minutes per visit watching YouTube videos" - https://gyre.pro/blog/how-to-increase-average-youtube-watch-time-and-why-it-matters

| Тип трафика         | Суммарный (Тбит/сутки) | Средний (Тбит/с) | Пиковый (Тбит/с) | Расчет                                                                                                                                                                                                    |
| ----------------------------- | ---------------------------------------- | ---------------------------- | ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Видео (просмотр) | 78552                                    | 0.908                        | 4.54                         | 30 мин * вес 1 минуты видео (24 Мбайт) * DAU - суммарный.<br />суммарный /  86400 * 5 (Выбрал такой коэффициент пиковой нагрузки) |
| Видео (загрузка) | 7910                                     | 0.09155                      | 0.45775                      | 30000 минут * вес минуты  / 60 (потому что в минуту было)                                                                                                                    |

### RPS

Коэффициент пиковой нагрузки возьмём за  24 часа в день / пиковую нагрузку в вечернее вреся с 17-22 =  5. (Вечерняя нагрузка большая, потому что большинство пользователей находятся в Европейской части и пользователи не разбросаны по земному шару)
Берем расчеты из первой таблицы - они месячные. Поделим их на 30 а потом на колличество секунд в дне и умножим на DAU

| Тип запроса             | Средний RPS | Пиковый RPS | Расчет                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| --------------------------------- | ------------------ | ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Просмотр видео       | 1471               | 7357               | 266.72 / (ToR = 30 / 86400 * DAU))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Лайки видео             | 141                | 705                | 25.5 / ToR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| Лайки комментария | 28                 | 141                | 5.1 / ToR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Комментарии            | 45                 | 226                | 8.22 / ToR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| Подписки                  | 0.8                | 4                  | 1 млн новых пользователей / RMAU = 28k новых пользователей на Рутубе, каждый за месяц<br />набирает по 70 подписок, соответственно: 28000 * 70 / 30 / 86400                                                                                                                                                                                                                                                                                                                   |
| Плейлисты                | 33                 | 165                | 2 / ToR * 3 (Плейлисты еще могут просматривать а не только создавать,<br />выбрал число из своих сооброжений)                                                                                                                                                                                                                                                                                                                                                                                |
| Авторизация            | 0.8275             | 4.14               | Сессия рутуба длиться довольно долго, но точной информации я не смог найти в интернете,<br />могу сказать, что только 15% пользователей будут авторизовываться, то есть где-то 2.145 млн в день.<br />Посчитаем исходя их этого.                                                                                                                                                                  |
| Регистрация            | 0.386              | 2                  | "with an additional one million or more registered as of the end of January 2024" -<br />https://thumbnailtest.com/stats/youtube/ миллион человек регистрируется в месяц / 30 / 86400<br />Сдесь сложно коррелировать данные Ютуба и Рутуба, потому что Рутуб активно набирает пользователей,<br />когда Ютуб уже большенство набрал, поэтому тут коэффициент добавлять не стану. |
| Загрузка видео       | 43                 | 213                | Возьмем из 500 часов в минуту и средней длины видео, получим сколько видео в<br />минуту грузят и поделим на 60                                                                                                                                                                                                                                                                                                                                                                         |
| История просмотра | 58.8               | 294.               | При каждом просмотре видое + примем коэффициент того, что раз в 25 видео пользователь будет заходить в свою историю<br />просмотра, получим 26 * RPS Для Просмотра / 25                                                                                                                                                                                                                                                                          |

### Прирост диска.

Прирост будет осуществляться за счёт загрузки видео

"500 hours of content uploaded every minute" https://blog.youtube/press/ - Статистика для ютуба, для рутуба же будет деленая на 35.5(RMAU), т.е 608 450 часов в месяц.
Знаю сколько весит в среднем 1 минута видео находим прирост диска: 835.6 Тбайт/месяц

# 3. Глобальная балансировка

### 3.1 Выбор доменов

* Основной домен - `rutube.ru`

### 3.2 Обоснования выборов ДЦ

Распределение трафика по странам

| Процент | Страна       |
| -------------- | ------------------ |
| 92 %           | Россия       |
| 4 %            | Казахстан |
| 4 %            | Беларусь   |

 Исходя из крупных городов этих стран целесообразно ДЦ разместить в следующих точках:

* Москва
* Санкт-Питербург
* Астана
* Владивосток

![1741711528538](img/DC_map.png)

Такой выбор позволят связать всю России и ближайшие страны СНГ при малом количестве ДЦ.

### 3.3 Технологии глобальной балансировки

##### **DNS**

**Latency-based DNS** - заказываем у Amazon и получаем опитимальную доставку видео пользователям без задержки.

* Пользователь отправляет DNS-запрос к `rutube.ru`.
* Route 53 определяет его местоположение и измеряет задержку до всех ДЦ.
* Возвращается IP-адрес ДЦ с наименьшей задержкой

Пользователь → Local DNS → Amazon Route 53
            			                    ↓          ↓         ↓
            				   Владивосток    Астана   СПб  / Москва (Под одним IP /24)

##### BGS

Можно использовать **BGP Anycast** для доставки данных после получения айпишника внутри сети /24 для Москвы или Владивостока.

* ДЦ анонсируют один и тот же IPv4-префикс возьмём 203.0.113.0/24 через BGP.
* Каждый ДЦ имеет уникальный **Autonomous System Number (ASN)** и устанавливает BGP-сессии с локальными провайдерами
  Москва → AS64500, Владивосток → AS64501
* Пользователь, получив IP через DNS, отправляет запрос на 203.0.113.10
* B-маршрутизаторы в интернете выбирают кратчайший AS-path или путь с наименьшей задержкой к префиксу.
* Трафик направляется в ближайший ДЦ, анонсирующий `203.0.113.0/24`.

Префикс 203.0.113.0/24 анонсируется через BGP:

- Москва: AS64500 → Ростелеком, Билайн
- Владивосток: AS64501 → Мтс, Теле2

#### Распределение нагрузки по ДЦ

| Параметр         | Общая нагрузка (RPS) | Москва (35%) | Санкт-Питербург (25%) | Астана (25%) | Владивосток (15%) |
| ------------------------ | --------------------------------- | ------------------ | ----------------------------------- | ------------------ | ---------------------------- |
| **Общий RPS** | 3,280.2135                        | 1,148.075          | 820.053                             | 984.064            | 328.021                      |

# **4. Локальная балансировка**

Будет импользовать Software Load Balancer **Nginx** для проксирования запросов внутри ДЦ.
Для аркестрации контейнеров на бекенда будем исользовать **Kubernates**, который гарантирует отказоустойчивость правильной манипуляцией контейнерами.

Из возможных вариантов **Layer 4 Load Balancing** будем использовать**:**

* **Virtual Server via IP Tunneling**: Подменяем айпишник отправителя на пакете на входе в ДЦ на виртуальный после чего сам Application Server отсылает пакет пользователю, таким образом для пользователя
  будет отвечать как бы прокся и не будут ведны внутренние сервера ДЦ. + Способа в том, что разгружаем балансер, он не является "горлышком бутылки". Он гарантирует отказоустойчивость тем, что при отказе сервера нагрузка распределиться между остальными.

Хорошая практика использования **Layer 7 Load Balancing:**

* **HTTP Reverse Proxy**: Парсит HTTP запрос и после HTTP ответ бекенда. Очень оптимален, когда раздает статитуку. Динамику передаёт в бекенд.
  Может кешировать, делать gzip, поддерживать несколько конекшенов.
* Проверять авторизацию сразу через Nginx , посылая запрос на нужны сервис, таким образом защищаться от DDoS от неавторизаванных пользователей, также можно
  блокировать авторизованных пользователей через IP.
* В случае сихронного бекенда сильно повышает производительность из-за своей асинхронностью, таким образом можно смотреть, где занятые воркеры и отправлять на нужные бекенды.
  Таким образом гарантируется отказоустойчивость.

**Reverse proxy (обратный прокси)** — это  **сервер, который действует как посредник между клиентами и одним или несколькими серверами** , скрывая внутреннюю инфраструктуру от внешних пользователей.

В отличие от обычного прокси-сервера, который работает от имени клиента, реверс-прокси принимает запросы от клиентов и перенаправляет их на серверы, которые выполняют обработку.

![1742722838932](image/README/1742722838932.png)

**SSL Termination**: После попадания в датацентр балансер будет дешифровывать данные и дальше передавать по HTTP, уменьшив оверхед. Покупать будем SSL сертификаты для поддержки всех браузеров.
